<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="icon" href="images/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="./css/bootstrap.min.css">
    <link rel="stylesheet" href="./css/font-awesome.min.css">
    <link rel="stylesheet" href="./css/common.css">
    <link rel="stylesheet" href="./css/shoppingCar.css">
    <title>购物车页</title>
</head>
<body>
    <div class="car-page">
        <div class="mini-header ">
            <div class="header-container clear">
                <div class="header-logo clear fl">
                    <a href="./index.html" class="logo fl">
                        
                    </a>
                </div>
                <h2 class="header-title fl">我的购物车</h2>
                <div class="topbar fr">
                    <span class="user" v-show="isLogin">
                        <a href="#" class="user-name">
                            <span class="name" v-text="name"></span>
                            <i class="fa fa-angle-down"></i>
                        </a>
                    </span>
                    <span><a href="./login.html" v-show="!isLogin" class="link-order">登录</a></span>

                    <ul class="user-menu " style="display:none;">
                        <li>
                            <a href="#">个人中心</a>
                        </li>
                        <li>
                            <a href="#">评价晒单</a>
                        </li>
                        <li>
                            <a href="#">我的喜欢</a>
                        </li>
                        <li>
                            <a href="#">小米账户</a>
                        </li>
                        <li>
                            <a href="#">退出登录</a>
                        </li>
                    </ul>
                    <span class="" style="color: #e0e0e0">|</span>
                    <a href="#" class="link-order" v-show="isLogin">
                        我的订单
                    </a>
                    <a href="./register.html" class="link-order" v-show="!isLogin">注册</a>
                </div>
            </div>
        </div>
        <div class="page-mian">
            <div class="page-container">
                <div class="cart-empty" v-show="!hasProduct">
                    <h2>您的购物车还是空的！</h2>
                    <a href="#" class="btn">马上去购物</a>
                </div>
                <div class="carList" v-show="hasProduct">
                    <div class="car-header clear">
                        <div class="allcheck fl" >
                            <span class="checkbox" @click="checkall">
                                <i class="glyphicon glyphicon-ok"></i>
                            </span>
                            
                            全选
                        </div>
                        <div class="car-image fl"></div>
                        <div class="car-name fl">商品名称</div>
                        <div class="car-value fl">单价</div>
                        <div class="car-num fl">数量</div>
                        <div class="car-total fl">小计</div>
                        <div class="car-action fl">操作</div>
                    </div>
                    <div class="car-item clear" v-for="item,index in shopCarList">
                        <div class="allcheck fl">
                            <span class="checkbox" @click="check(index)">
                                <i class="glyphicon glyphicon-ok"></i>
                            </span>
                        </div>
                        <div class="car-image fl">
                            <a href="#">
                            <img :src="item.img" alt="" width="80px;" width="80px;">
                            </a>
                        </div>
                        <div class="car-name fl" >
                            
                            <a href="" v-text="item.product"></a>
                            
                        </div>
                        <div class="car-value fl" >
                            <span v-text="item.price+'元'"></span>
                        </div>
                        <div class="car-num fl" >
                            
                                <span class="num-down" @click="decreasenum(index)">
                                        <i class="glyphicon glyphicon-minus"></i>
                                </span>
                                    
                                <span v-text="item.num" class="num-txt"></span>
                                <span class="num-up" @click="addnum(index)">
                                    <i class="glyphicon glyphicon-plus"></i>
                                </span>
                
                            
                        </div>
                        <div class="car-total fl">
                            <span>{{item.price * item.num}}元</span>
                        </div>
                        <div class="car-action fl">
                            <a>
                                <i class="fa fa-times"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>
                <div class="allmoney clear">
                    <div class="left-section fl">
                        <a href="./index.html">继续购物</a>
                        <span class="sep"></span>
                        <span>共<span v-text="productnum"  class="yel"></span> 件商品，已选择 <span v-text="choosenum" class="yel"></span>件</span>
                    </div>
                    <div class="right-section fr">
                        <span class="total-txt">
                            合计: <span v-text="alltotal"></span>元
                        </span>
                        <button>去结算</button>
                    </div>
                </div>
                <h2 class="recommend-title">
                    <span>为您推荐</span>
                </h2>
            </div>
        </div>
        <!-- 页尾 -->
        <div class="footer">
            <div class="container">
                <div class="site-footer">
                    <div class="footer-service">
                        <ul class="list-service clear">
                            <li>
                                <a href="javascript:"><span class="iconfont">&#xe603;</span>1小时快修服务</a>
                            </li>
                            <li>
                                <a href="javascript:"><span class="iconfont">&#xe638;</span>7天无理由退货</a>
                            </li>
                            <li>
                                <a href="javascript:"><span class="iconfont">&#xe605;</span>15天免费换货</a>
                            </li>
                            <li>
                                <a href="javascript:"><span class="iconfont">&#xe607;</span>满150元包邮</a>
                            </li>
                            <li>
                                <a href="javascript:"><span class="iconfont">&#xe606;</span>520余家售后网点</a>
                            </li>
                        </ul>
                    </div>
                    <div class="footer-links clear">
                        <dl class="col-links ">
                            <dt>帮助中心</dt>
                            <dd><a href="javascript:">购物指南</a></dd>
                            <dd><a href="javascript:">支付方式</a></dd>
                            <dd><a href="javascript:">配送方式</a></dd>
                        </dl>
                        <dl class="col-links ">
                            <dt>服务支持</dt>
                            <dd><a href="javascript:">售后政策</a></dd>
                            <dd><a href="javascript:">自助服务</a></dd>
                            <dd><a href="javascript:">相关下载</a></dd>
                        </dl>
                        <dl class="col-links ">
                            <dt>大米之家</dt>
                            <dd><a href="javascript:">大米之家</a></dd>
                            <dd><a href="javascript:">服务网点</a></dd>
                            <dd><a href="javascript:">预约服务</a></dd>
                        </dl>
                        <dl class="col-links ">
                            <dt>关于大米</dt>
                            <dd><a href="javascript:">了解大米</a></dd>
                            <dd><a href="javascript:">加入大米</a></dd>
                            <dd><a href="javascript:">联系我们</a></dd>
                        </dl>
                        <dl class="col-links ">
                            <dt>关注我们</dt>
                            <dd><a href="javascript:">新浪微博</a></dd>
                            <dd><a href="javascript:">大米部落</a></dd>
                            <dd><a href="javascript:">官方微信</a></dd>

                        </dl>
                        <dl class="col-links ">
                            <dt>特色服务</dt>
                            <dd><a href="javascript:">F 码通道</a></dd>
                            <dd><a href="javascript:">大米移动</a></dd>
                            <dd><a href="javascript:">防伪查询</a></dd>
                        </dl>
                        <div class="col-contact">
                            <p class="phone">400-000-0000</p>
                            <p>
                                <span class="J_serviceTime-normal" style="">周一至周日 8:00-18:00</span>
                                <br>（仅收市话费）
                            </p>
                            <a class="btn  btn-small" href="javascript:"><span class="iconfont">&#xe615;</span> 24小时在线客服</a>
                        </div>
                    </div>
                </div>
                <div class="site-info container">
                    <div class="logo2">
                        <img src="images/logo-footer.png" alt="">
                    </div>
                    <div class="info-text">
                        <p class="sites">
                            <a href="javascript:">大米网</a><span class="sep">|</span>
                            <a href="javascript:">MIII</a><span class="sep">|</span>
                            <a href="javascript:">我聊</a><span class="sep">|</span>
                            <a href="javascript:">多看书城</a><span class="sep">|</span>
                            <a href="javascript:">大米路由器</a><span class="sep">|</span>
                            <a href="javascript:">视频电话</a><span class="sep">|</span>
                            <a href="javascript:">大米后院</a><span class="sep">|</span>
                            <a href="javascript:">大米天猫店</a><span class="sep">|</span>
                            <a href="javascript:">大米淘宝直营店</a><span class="sep">|</span>
                            <a href="javascript:">大米网盟</a><span class="sep">|</span>
                            <a href="javascript:">问题反馈</a><span class="sep">|</span>
                            <a href="javascript:">Select Region</a>
                        </p>
                        <p>
                            <a href="javascript:">©mmmm
                            <br>
                            除特殊说明，所有数据均出自我司实验室测试</a>
                    </div>
                    <div class="info-links">
                        <a href="javascript:"><img src="images/truste.png"></a>
                        <a href="javascript:"><img src="images/v-logo-2.png"></a>
                        <a href="javascript:"><img src="images/v-logo-1.png"></a>
                        <a href="javascript:"><img src="images/v-logo-3.png"></a>
                    </div>
                    <div class="slogan"></div>
                </div>
            </div>
        </div>
    </div>
    <script src="./js/jquery-1.11.3.js"></script>
    <script src="./js/vue.js"></script>
    <script src="./js/vue-resource.js"></script>
    <script>
        new Vue({
            el: ".car-page",
            data: {
                isLogin: false,
                hasProduct: false,
                shopCarList: [],
                alltotal: 0,
                productnum: 0,
                choosenum: 0,
                name: '',
                selected: true
            },
            methods: {
                decreasenum: function(index) {
                    if(this.shopCarList[index].num<=1) {
                        alert("已经只有一个了")
                        return
                    }
                    var product = this.shopCarList[index].product
                    var price = this.shopCarList[index].price
                    var img = this.shopCarList[index].img
                    var miID = sessionStorage.getItem('showName')
                    if(this.isLogin) {
                        this.$http.post('/addtocar',{
                            "miID": miID, 
                            "product": product,
                            "price": price,
                            "img": img,
                            "num": -1
                        }).then(function(res) {
                            if(res.body.errno === 0) {
                                console.log('data',res.body)
                                alert(res.body.msg)
                                this.shopCarList[index].num--
                                this.alltotal -= price
                                this.productnum--
                                if(this.shopCarList[index].selected) {
                                    this.choosenum--
                                }
                            }else{
                                alert("减少失败")
                            }
                        })
                    }else {
                        this.shopCarList[index].num--
                        this.alltotal -= price
                        this.productnum--
                        sessionStorage.setItem('shopCarStr',this.shopCarList)
                        if(this.shopCarList[index].selected) {
                                    this.choosenum--
                                }
                    }
                    
                },
                addnum: function(index) {
                    if(this.isLogin) {
                        var product = this.shopCarList[index].product
                        var price = this.shopCarList[index].price
                        var img = this.shopCarList[index].img
                        var miID = sessionStorage.getItem('showName')
                        this.$http.post('/addtocar',{
                            "miID": miID, 
                            "product": product,
                            "price": price,
                            "img": img,
                            "num": 1
                        }).then(function(res) {
                            if(res.body.errno === 0) {
                                console.log('data',res.body)
                                alert(res.body.msg)
                                this.shopCarList[index].num++
                                this.alltotal += price
                                this.productnum++
                                if(this.shopCarList[index].selected) {
                                    this.choosenum++
                                }
                            }else{
                                alert("添加失败")
                            }
                           
                           
                        })
                    }else {
                        this.shopCarList[index].num++
                        this.shopCarList[index].num++
                        this.alltotal += price
                        this.productnum++
                        sessionStorage.setItem('shopCarStr',this.shopCarList)
                        if(this.shopCarList[index].selected) {
                                    this.choosenum++
                                }
                    }
                },
                checkall: function() {
                    this.selected = !this.selected
                    console.log(this.selected)
                    if(!this.selected) {
                        $('.checkbox').css({"background":"#fff","border":"1px solid #e0e0e0"}).children('i').removeClass('glyphicon glyphicon-ok')
                        this.choosenum = 0
                        this.alltotal = 0
                        for(var j=0;j<this.shopCarList.length;j++) {
                            this.shopCarList[j].selected = false
                        }
                    }else {
                        $('.checkbox').css({"background":"#ff6700","border":"1px solid #ff6700"}).children('i').addClass('glyphicon glyphicon-ok')
                        this.choosenum = this.productnum
                        this.alltotal = 0
                        for(var i = 0;i<this.shopCarList.length;i++) {
                            this.alltotal += this.shopCarList[i].price*this.shopCarList[i].num
                            this.shopCarList[i].selected = true
                        }
                    }
                },
                check: function(index) {
                    this.shopCarList[index].selected = !this.shopCarList[index].selected
                    if(!this.shopCarList[index].selected) {
                        $(".car-item .checkbox").eq(index).css({"background":"#fff","border":"1px solid #e0e0e0"}).children('i').removeClass('glyphicon glyphicon-ok')
                        this.alltotal = this.alltotal - (this.shopCarList[index].price*this.shopCarList[index].num)
                        this.choosenum = this.choosenum - this.shopCarList[index].num
                        this.shopCarList[index].selected = false
                    }else {
                        $('.car-item .checkbox').eq(index).css({"background":"#ff6700","border":"1px solid #ff6700"}).children('i').addClass('glyphicon glyphicon-ok')
                        this.alltotal = this.alltotal + (this.shopCarList[index].price*this.shopCarList[index].num)
                        this.choosenum = this.choosenum + this.shopCarList[index].num
                        this.shopCarList[index].selected = true
                    }
                    
                }
            },
            created: function() {
                this.isLogin = sessionStorage.getItem('isLogin')
                var str = sessionStorage.getItem('shopCarStr')
                if(this.isLogin) {
                    this.name = sessionStorage.showName
                    this.$http.get('/shopcar',{
                        params:{
                            miID: sessionStorage.getItem('showName')
                        }
                    }).then(function(res) {
                        //console.log(res.body.data)
                        console.log(res.body)
                        this.shopCarList = res.body.data
                        console.log("主页",this.shopCarList)
                        if(this.shopCarList.length<=0) {
                            this.hasProduct = false
                        }else {
                            this.hasProduct = true
                            for(let i = 0;i<this.shopCarList.length;i++) {
                            this.shopCarList[i].selected = true
                            
                            this.productnum += this.shopCarList[i].num
                            
                            this.alltotal += this.shopCarList[i].price*this.shopCarList[i].num
                        }
                        //console.log(this.alltotal)
                        this.choosenum = this.productnum
                        }
                    })

                }else {
                    
                    if(!str) {
                        this.hasProduct = false
                    }else {
                        
                        var obj = JSON.parse(str)
                        this.shopCarList = obj.shopCarArr
                        this.hasProduct = true
                        for(let i = 0;i<obj.shopCarArr.length;i++) {
                            this.shopCarList[i].selected = true
                            this.productnum += obj.shopCarArr[i].num
                            this.alltotal += obj.shopCarArr[i].price*obj.shopCarArr[i].num
                        }
                    }
                }
            }
        })
    </script>
    <script src="./js/shoppingCar.js"></script>
</body>
</html>